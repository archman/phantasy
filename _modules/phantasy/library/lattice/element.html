<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>phantasy.library.lattice.element &mdash; phantasy 2.1.2 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/frib-favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> phantasy
          </a>
              <div class="version">
                2.1.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../src/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../src/deploy.html">Deployment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../src/tut.html">User Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features Highlight</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../src/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../src/features.html#gui-applications">GUI Applications</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../src/apiref.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../src/terms.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">phantasy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>phantasy.library.lattice.element</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for phantasy.library.lattice.element</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;Build elements with Channel Access support.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">epics</span> <span class="kn">import</span> <span class="n">PV</span><span class="p">,</span> <span class="n">get_pv</span>
<span class="kn">from</span> <span class="nn">phantasy.library.misc</span> <span class="kn">import</span> <span class="n">flatten</span>
<span class="kn">from</span> <span class="nn">phantasy.library.misc</span> <span class="kn">import</span> <span class="n">convert_epoch</span>
<span class="kn">from</span> <span class="nn">phantasy.library.misc</span> <span class="kn">import</span> <span class="n">QCallback</span>
<span class="kn">from</span> <span class="nn">phantasy.library.pv</span> <span class="kn">import</span> <span class="n">PV_POLICIES</span>
<span class="kn">from</span> <span class="nn">phantasy.library.pv</span> <span class="kn">import</span> <span class="n">unicorn_read</span>
<span class="kn">from</span> <span class="nn">phantasy.library.pv</span> <span class="kn">import</span> <span class="n">unicorn_write</span>
<span class="kn">from</span> <span class="nn">phantasy.library.pv</span> <span class="kn">import</span> <span class="n">ensure_put</span>
<span class="kn">from</span> <span class="nn">phantasy.library.settings</span> <span class="kn">import</span> <span class="n">get_settings_from_element_list</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Empty</span>


<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">VALID_STATIC_KEYS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;sb&#39;</span><span class="p">,</span>
    <span class="s1">&#39;phy_name&#39;</span><span class="p">,</span> <span class="s1">&#39;phy_type&#39;</span><span class="p">,</span> <span class="s1">&#39;machine&#39;</span><span class="p">,</span>
    <span class="s1">&#39;alignment_data&#39;</span> <span class="c1"># defined by a separated file.</span>
<span class="p">)</span>
<span class="n">VALID_CA_KEYS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;field_eng&#39;</span><span class="p">,</span> <span class="s1">&#39;field_phy&#39;</span><span class="p">,</span> <span class="s1">&#39;handle&#39;</span><span class="p">,</span> <span class="s1">&#39;pv_policy&#39;</span><span class="p">)</span>
<span class="c1"># diagnostic device types</span>
<span class="n">DIAG_DTYPES</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;EMS&#39;</span><span class="p">,</span> <span class="s1">&#39;PM&#39;</span><span class="p">,</span> <span class="s1">&#39;BPM&#39;</span><span class="p">,</span> <span class="s1">&#39;BCM&#39;</span><span class="p">,</span> <span class="s1">&#39;ND&#39;</span><span class="p">,</span> <span class="s1">&#39;HMR&#39;</span><span class="p">,</span> <span class="s1">&#39;IC&#39;</span><span class="p">,</span> <span class="s1">&#39;VD&#39;</span><span class="p">)</span>
<span class="c1"># DIAG_DTYPES = (&#39;BPM&#39;, &#39;BCM&#39;, &#39;VD&#39;)</span>


<span class="k">class</span> <span class="nc">BaseElement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all elements, contains most of the device properties,</span>
<span class="sd">    such as element name, length, location and family. It also keeps a list of</span>
<span class="sd">    groups which belongs to.</span>

<span class="sd">    ``BaseElement`` does not support Channel Access, ``CaElement`` does.</span>

<span class="sd">    Keyword Arguments</span>
<span class="sd">    -----------------</span>
<span class="sd">    name : str</span>
<span class="sd">        Element name.</span>
<span class="sd">    family : str</span>
<span class="sd">        Element type.</span>
<span class="sd">    index : int</span>
<span class="sd">        Element index, default sort key, otherwise, ``sb`` is used as sort key.</span>
<span class="sd">    length : float</span>
<span class="sd">        Effective element length.</span>
<span class="sd">    sb : float</span>
<span class="sd">        Longitudinal position at the beginning of device, unit: *m*.</span>
<span class="sd">    se : float</span>
<span class="sd">        Longitudinal position at the end of device, unit: *m*.</span>
<span class="sd">    enable : True or False</span>
<span class="sd">        Element is enabled or not, ``True`` is controllable, default is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;family&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">se</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;se&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sb</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enable&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_family</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set: Groups element belongs to.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span>

    <span class="nd">@group</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;group&#39;: Input should be a set.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: Element name, None if not given.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;name&#39;: Input should be a string.&quot;</span><span class="p">)</span>

    <span class="n">ename</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;int: Element index, ``-1`` if not given.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>

    <span class="nd">@index</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;index&#39;: Invalid string to integer.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;index&#39;: Input should be an integer.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">family</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: Element family, i.e. device type, None if not given.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_family</span>

    <span class="nd">@family</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">family</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_family</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_family</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;family&#39;: Input should be a string.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;float: Element length, *m*, 0.0 if not given.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span>

    <span class="nd">@length</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;length&#39;: Invalid string to float.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;length&#39;: Input should be a float number.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;float: Longitudinal position at the beginning of device, *m*.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sb</span>

    <span class="nd">@sb</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;sb&#39;: Invalid string to float.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;sb&#39;: Input should be a float number.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">se</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;float: Longitudinal position at the end of device, *m*.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_se</span>

    <span class="nd">@se</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">se</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_se</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;se&#39;: Invalid string to float.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;se&#39;: Input should be a float number.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bool: Element is controllable or not, ``True`` by default.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span>

    <span class="nd">@active</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">new_flag</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">!=</span> <span class="n">new_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="n">new_flag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Active status: </span><span class="si">{}</span><span class="s2"> is not changed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_flag</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0:04d}</span><span class="s2"> | </span><span class="si">{1:&lt;20s}</span><span class="s2"> </span><span class="si">{2:&lt;8s}</span><span class="s2"> </span><span class="si">{3:^6.2f}</span><span class="s2"> [m] </span><span class="si">{4:^6.6f}</span><span class="s2"> [m]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sb</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> [</span><span class="si">%s</span><span class="s2">] @ sb=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sb</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;use *index* if not None, otherwise use *sb*&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sb</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">sb</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sb</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">sb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1"> may be the same one&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;compares location, length and name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sb</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">sb</span> <span class="ow">and</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">length</span> <span class="ow">and</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sb</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_update_static_props</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Non-CA&quot;&quot;&quot;</span>
        <span class="c1">#kws: alignment, series of alignment data</span>
        <span class="n">alignment_data</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alignment&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;alignment&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;alignment&#39;</span><span class="p">,</span> <span class="n">alignment_data</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> already has </span><span class="si">{1}</span><span class="s2"> of </span><span class="si">{2}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if element is diagnostic device or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_family</span> <span class="ow">in</span> <span class="n">DIAG_DTYPES</span>


<div class="viewcode-block" id="CaField"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField">[docs]</a><span class="k">class</span> <span class="nc">CaField</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Channel Access support for element field.</span>

<span class="sd">    Usually, ``CaField`` instance has at most three types of PV names:</span>
<span class="sd">    *readback*, *readset* and *setpoint*, each PV should linked with valid</span>
<span class="sd">    PV connections.</span>

<span class="sd">    There are two approaches to retrieve the PV values, one is through</span>
<span class="sd">    ``value`` attribute, another one is by explicitly calling ``get()``;</span>

<span class="sd">    The same rule applies to set values, i.e. by setting ``value`` attribute</span>
<span class="sd">    and by calling ``put()`` method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of CA field, usually represents the physics attribute linked with CA.</span>

<span class="sd">    Keyword Arguments</span>
<span class="sd">    -----------------</span>
<span class="sd">    wait : bool</span>
<span class="sd">        Wait or not (True/False) when issuing set command, which is attached</span>
<span class="sd">        to one of &#39;caput&#39; keyword arguments, default: False.</span>
<span class="sd">    timeout : float</span>
<span class="sd">        Time out in second for put operation (see wait), default is 10 seconds.</span>
<span class="sd">    ensure_put : bool</span>
<span class="sd">        Apply ensure set operation or not, default is False, see the notes.</span>
<span class="sd">    tolerance : float</span>
<span class="sd">        Absolute discrepancy tolerance between current readback value</span>
<span class="sd">        and the set goal, default is 0.01.</span>
<span class="sd">    ename : str</span>
<span class="sd">        Name of element which the field attaches to.</span>
<span class="sd">    readback : str, list(str)</span>
<span class="sd">        Readback PV name(s), if a single string is defined, append operation</span>
<span class="sd">        will be issued, if list or tuple of strings is defined, *readback*</span>
<span class="sd">        attribute will be overwritten with the new list, the same rule applies</span>
<span class="sd">        to *readset* and *setpoint*, as well as *readback_pv*, *readset_pv* and</span>
<span class="sd">        *setpoint_pv*.</span>
<span class="sd">    readset : str, list(str)</span>
<span class="sd">        Readset PV name(s).</span>
<span class="sd">    setpoint : str, list(str)</span>
<span class="sd">        Setpoint PV name(s).</span>
<span class="sd">    pv_policy : dict</span>
<span class="sd">        Name of PV read/write policy, keys: &#39;read&#39; and &#39;write&#39;, values:</span>
<span class="sd">        scaling law function object.</span>
<span class="sd">    polarity : int</span>
<span class="sd">        Device polarity, -1 or 1.</span>
<span class="sd">    ftype : str</span>
<span class="sd">        Field type, &#39;ENG&#39; (default) or &#39;PHY&#39;.</span>
<span class="sd">    auto_monitor : bool</span>
<span class="sd">        If set True, initialize all channels auto subscribe, default is False.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    About `ensure_put` option: If this argument is set True, the set or put</span>
<span class="sd">    action to the field value will be ensured to reach the goal, since</span>
<span class="sd">    CA put wait action sometimes is not that working as the user expected. To</span>
<span class="sd">    make use of this feature, simply set `field.ensure_put = True`, then</span>
<span class="sd">    do `field.value = x`, the program will be blocked until `field.value`</span>
<span class="sd">    reaches `x`, here assumed `field` is the instance of `CaField` class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ename</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wait&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tolerance&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_put</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ensure_put&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_am</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auto_monitor&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readback</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readback&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readset</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readset&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setpoint</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setpoint&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_pvs</span><span class="p">()</span>
        <span class="n">pv_policy</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv_policy&#39;</span><span class="p">,</span> <span class="n">PV_POLICIES</span><span class="p">[</span><span class="s1">&#39;DEFAULT&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;polarity&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default_read_policy</span> <span class="o">=</span> <span class="n">pv_policy</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_write_policy</span> <span class="o">=</span> <span class="n">pv_policy</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_read_policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_write_policy</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ftype&#39;</span><span class="p">,</span> <span class="s1">&#39;ENG&#39;</span><span class="p">)</span>
        <span class="c1"># callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">validate_polarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;read&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">validate_polarity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">validate_polarity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: Field name, empty string if not given.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Field name should be a valid string.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: Name of element the field attaches to.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ename</span>

    <span class="nd">@ename</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ename</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Element name should be a valid string&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;boolean: Wait or not (True/False) when issuing set command, which</span>
<span class="sd">        is attached to one of &#39;caput&#39; keyword arguments, default: False.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span>

    <span class="nd">@wait</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">polarity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;int: Device polarity, trend response of the physics field (+/-1) w.r.t. input current (+).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;ENG&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Polarity of an engineering field does not have practical meaning.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_polarity</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Polarity of </span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">] is not consistent with unit scaling law!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span>

    <span class="nd">@polarity</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">polarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polarity</span> <span class="o">=</span> <span class="n">i</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ensure_put</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;boolean: Apply ensure set operation or not, default is False.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_put</span>

    <span class="nd">@ensure_put</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ensure_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_put</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_put</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;float: Time out in second for put operation, default: 10 [sec].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>

    <span class="nd">@timeout</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tolerance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;float: Absolute discrepancy tolerance between current readback value</span>
<span class="sd">        and the set goal, default is 0.01.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tolerance</span>

    <span class="nd">@tolerance</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">tolerance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tolerance</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tolerance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">readback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;list[str]: Readback PV name, usually ends with *_RD*.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv_name</span>

    <span class="nd">@readback</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">readback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If *s* is a string, append *s* to the current readback list,</span>
<span class="sd">        otherwise override the current readback PV name list, the</span>
<span class="sd">        same policy applies to *setpoint* and *readset*.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Readback PV aleady exists.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Readback PV not update.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Readback PV name should a valid string or list of string.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">readset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;list[str]: Readset PV name, usually ends with *_RSET*.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv_name</span>

    <span class="nd">@readset</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">readset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Readset PV aleady exists.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Readset PV not update.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Readset PV name should a valid string or list of string.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">setpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;list[str]: Setpoint PV name, usually ends with *_CSET*.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv_name</span>

    <span class="nd">@setpoint</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">setpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setpoint PV aleady exists.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setpoint PV not update.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Setpoint PV name should a valid string or list of string.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">readback_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;PV: Readback PV object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span>

    <span class="nd">@readback_pv</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">readback_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pvobj</span><span class="p">,</span> <span class="n">PV</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pvobj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pvobj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Readback PV object already exists.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pvobj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pvobj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Input PV should be (list of) PV object.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">readset_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;PV: Readset PV object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span>

    <span class="nd">@readset_pv</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">readset_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pvobj</span><span class="p">,</span> <span class="n">PV</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pvobj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pvobj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Readset PV object already exists.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pvobj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pvobj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Input PV should be (list of) PV object.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">setpoint_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;PV: Setpoint PV object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span>

    <span class="nd">@setpoint_pv</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">setpoint_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pvobj</span><span class="p">,</span> <span class="n">PV</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pvobj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pvobj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setpoint PV object already exists.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pvobj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pvobj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Input PV should be PV object.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">readback</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">readback</span> <span class="ow">and</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">setpoint</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">setpoint</span> <span class="ow">and</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">readset</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">readset</span> <span class="ow">and</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">write_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Defined write policy, i.e. how to set value to field.</span>

<span class="sd">        The defined policy is a function, with *setpoint_pv* attribute and new</span>
<span class="sd">        value as arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_policy</span>

    <span class="nd">@write_policy</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">write_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_write_policy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_policy</span> <span class="o">=</span> <span class="n">f</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">read_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Defined read policy, i.e. how to read value from field.</span>

<span class="sd">        The defined policy is a function, with *readback_pv* attribute as the</span>
<span class="sd">        argument, return a value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_policy</span>

    <span class="nd">@read_policy</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">read_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_read_policy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_policy</span> <span class="o">=</span> <span class="n">f</span>

<div class="viewcode-block" id="CaField.reset_policy"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.reset_policy">[docs]</a>    <span class="k">def</span> <span class="nf">reset_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset policy, by policy name (&#39;read&#39; or &#39;write&#39;), if not defined,</span>
<span class="sd">        reset both.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_read_policy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_write_policy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">policy</span> <span class="o">==</span> <span class="s1">&#39;read&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_read_policy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">policy</span> <span class="o">==</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_write_policy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid policy name, do not reset.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_reset_read_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_read_policy</span>

    <span class="k">def</span> <span class="nf">_reset_write_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_write_policy</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current readback value from readback PVs, intepret with</span>
<span class="sd">        read policy as the final field value as a return.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readback_pv</span><span class="p">)</span>

    <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the current field value as *v*, by applying write policy to</span>
<span class="sd">        attached setpoint PVs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_access</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">] is read only.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setpoint_pv</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                          <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

<div class="viewcode-block" id="CaField.init_pvs"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.init_pvs">[docs]</a>    <span class="k">def</span> <span class="nf">init_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;PV initialization.&quot;&quot;&quot;</span>
        <span class="n">rdbk_pv_name</span><span class="p">,</span> <span class="n">rset_pv_name</span><span class="p">,</span> <span class="n">cset_pv_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv_name</span><span class="p">,</span> \
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv_name</span><span class="p">,</span> \
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_rdbk_pv</span><span class="p">(</span><span class="n">rdbk_pv_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_rset_pv</span><span class="p">(</span><span class="n">rset_pv_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_cset_pv</span><span class="p">(</span><span class="n">cset_pv_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_rdbk_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvs</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_pv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">auto_monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_am</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pvs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_init_rset_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvs</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_pv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">auto_monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_am</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pvs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_init_cset_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvs</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_pv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">auto_monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_am</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pvs</span><span class="p">]</span>

<div class="viewcode-block" id="CaField.update_pv"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.update_pv">[docs]</a>    <span class="k">def</span> <span class="nf">update_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update PV with defined handle.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">        ------------------</span>
<span class="sd">        readback : str</span>
<span class="sd">        setpoint : str</span>
<span class="sd">        readset : str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;readback&#39;</span><span class="p">,</span> <span class="s1">&#39;readset&#39;</span><span class="p">,</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_pv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">get_pv</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">auto_monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_am</span><span class="p">))</span></div>

<div class="viewcode-block" id="CaField.pvs"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.pvs">[docs]</a>    <span class="k">def</span> <span class="nf">pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return dict of valid pv type and names.&quot;&quot;&quot;</span>
        <span class="n">pv_types</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;readback&#39;</span><span class="p">,</span> <span class="s1">&#39;readset&#39;</span><span class="p">,</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">)</span>
        <span class="n">pv_names</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readback</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">readset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint</span><span class="p">)</span>
        <span class="n">pv_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pv_types</span><span class="p">,</span> <span class="n">pv_names</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pv_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span></div>

<div class="viewcode-block" id="CaField.get"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="s1">&#39;readback&#39;</span><span class="p">,</span> <span class="n">n_sample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
            <span class="n">with_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ts_format</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="n">keep_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get value of PV with specified *handle*, if argument *n_sample* is</span>
<span class="sd">        larger than 1, statistical result with averaged value and standard</span>
<span class="sd">        deviation will be returned; the sample rate depends on the device</span>
<span class="sd">        scan rate. If *timeout* is defined, DAQ will be inactivated after</span>
<span class="sd">        *timeout* second. If PV is attached with a list pvs, the returned</span>
<span class="sd">        values are arrays, e.g. EQUAD usually has two power supply PVs to</span>
<span class="sd">        control one field.</span>

<span class="sd">        Warning</span>
<span class="sd">        -------</span>
<span class="sd">        For the case of devices that generate constant readings, if *n_sample*</span>
<span class="sd">        is larger than 1, set *timeout* parameter with a reasonable value is</span>
<span class="sd">        required, or this method will hang up your program.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        handle : str</span>
<span class="sd">            PV handle, &#39;readback&#39;, &#39;readset&#39; or &#39;setpoint&#39;.</span>
<span class="sd">        n_sample : int</span>
<span class="sd">            Sample number, total DAQ count.</span>
<span class="sd">        timeout : float</span>
<span class="sd">            Timeout in second for the whole DAQ process, set `None` to wait</span>
<span class="sd">            forever.</span>
<span class="sd">        with_timestamp : bool</span>
<span class="sd">            If `True`, return timestamp, default value is `False`.</span>
<span class="sd">        ts_format : str</span>
<span class="sd">            Format for timestamp, valid options: `raw`, `epoch` and `human`.</span>
<span class="sd">        keep_raw : bool</span>
<span class="sd">            If `True`, return raw read data as well.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        r : dict</span>
<span class="sd">            Valid keys: &#39;mean&#39;, &#39;std&#39;, &#39;timestamp&#39;, &#39;data&#39;, the values are</span>
<span class="sd">            the average of all shots, the standard deviation of all shots,</span>
<span class="sd">            the timestamp of the first shot, and all the aquired data array.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Get CA field instance from element:</span>

<span class="sd">        &gt;&gt;&gt; from phantasy import MachinePortal</span>
<span class="sd">        &gt;&gt;&gt; mp = MachinePortal(machine=&#39;&lt;mach_name&gt;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; lat = mp.work_lattice_conf</span>
<span class="sd">        &gt;&gt;&gt; elem = lat[0]</span>
<span class="sd">        &gt;&gt;&gt; print(elem.fields)</span>
<span class="sd">        &gt;&gt;&gt; fld = elem.get_field(&#39;&lt;field_name&gt;&#39;)</span>

<span class="sd">        Get readings from PVs with &#39;readback&#39; handle</span>

<span class="sd">        &gt;&gt;&gt; print(fld.get(&#39;readback&#39;))</span>

<span class="sd">        Get readings from PVs with &#39;setpoint&#39; handle</span>

<span class="sd">        &gt;&gt;&gt; print(fld.get(&#39;setpoint&#39;))</span>

<span class="sd">        Get readings from PVs with &#39;readset&#39; handle</span>

<span class="sd">        &gt;&gt;&gt; print(fld.get(&#39;readset&#39;))</span>

<span class="sd">        Get readings with timestamp</span>

<span class="sd">        &gt;&gt;&gt; fld.get(&#39;readback&#39;, with_timestamp=True)</span>

<span class="sd">        Define the style of timestamp</span>

<span class="sd">        &gt;&gt;&gt; fld.get(&#39;readback&#39;, with_timestamp=True, ts_format=&#39;human&#39;)</span>

<span class="sd">        Get statistical readings, and keep all the raw data</span>

<span class="sd">        &gt;&gt;&gt; fld.get(&#39;readback&#39;, n_sample=1, with_timestamp=True,</span>
<span class="sd">                    ts_format=&quot;epoch&quot;, keep_raw=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;readback&#39;</span><span class="p">:</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span>
        <span class="k">elif</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;readset&#39;</span><span class="p">:</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span>
        <span class="k">elif</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">:</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_auto_monitor</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">with_timestamp</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ipv</span> <span class="ow">in</span> <span class="n">pv</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">keep_raw</span><span class="p">:</span>
                        <span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">all_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get</span><span class="p">(</span><span class="n">ipv</span><span class="p">,</span> <span class="n">n_sample</span><span class="p">,</span> <span class="n">ts_format</span><span class="o">=</span><span class="n">ts_format</span><span class="p">,</span> <span class="n">keep_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">all_data</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get</span><span class="p">(</span><span class="n">ipv</span><span class="p">,</span> <span class="n">n_sample</span><span class="p">,</span> <span class="n">ts_format</span><span class="o">=</span><span class="n">ts_format</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_auto_monitor</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ipv</span> <span class="ow">in</span> <span class="n">pv</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">keep_raw</span><span class="p">:</span>
                        <span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">all_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get</span><span class="p">(</span><span class="n">ipv</span><span class="p">,</span> <span class="n">n_sample</span><span class="p">,</span> <span class="n">ts_format</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">keep_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">all_data</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get</span><span class="p">(</span><span class="n">ipv</span><span class="p">,</span> <span class="n">n_sample</span><span class="p">,</span> <span class="n">ts_format</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">avg</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_auto_monitor</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_auto_monitor</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CaField.set_am"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.set_am">[docs]</a>    <span class="k">def</span> <span class="nf">set_am</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set am to all pvs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">auto_monitor</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">i</span><span class="o">.</span><span class="n">clear_callbacks</span><span class="p">()</span>
            <span class="n">i</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_updates</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__on_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="s1">&#39;current_setting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_setting</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">[</span><span class="s1">&#39;writable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_access</span>
        <span class="c1"># print(f&quot;Update {self.ename}[{self.name}]: &quot;, self._args)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_callbacks</span><span class="p">()</span>

<div class="viewcode-block" id="CaField.unset_am"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.unset_am">[docs]</a>    <span class="k">def</span> <span class="nf">unset_am</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unset am to all pvs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">auto_monitor</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CaField.set"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="s1">&#39;setpoint&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set value(s) of PV(s) with specified *handle*, accept all *caput*</span>
<span class="sd">        keyword arguments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : list or list(val)</span>
<span class="sd">            New value(s) to be set.</span>
<span class="sd">        handle : str</span>
<span class="sd">            PV handle, &#39;readback&#39;, &#39;readset&#39; or &#39;setpoint&#39;.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Get CA field instance, see `get()`, set one field of an element</span>
<span class="sd">        which has two &#39;setpoint&#39; PVs, e.g. quad:</span>

<span class="sd">        &gt;&gt;&gt; fld.set([val1, val2], &#39;setpoint&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # Check with get:</span>
<span class="sd">        &gt;&gt;&gt; fld.get(&#39;setpoint&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # should return [val1, val2]</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        ``get()`` and ``set()`` are a pair of methods that can read/write PV(s)</span>
<span class="sd">        bypass field defined read/write policies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;readback&#39;</span><span class="p">:</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdbk_pv</span>
        <span class="k">elif</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;readset&#39;</span><span class="p">:</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rset_pv</span>
        <span class="k">elif</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">:</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cset_pv</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span>
        <span class="k">if</span> <span class="n">pv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="n">k</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="CaField.is_physics_field"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.is_physics_field">[docs]</a>    <span class="k">def</span> <span class="nf">is_physics_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if *field* is physics field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;PHY&#39;</span></div>

<div class="viewcode-block" id="CaField.is_engineering_field"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.is_engineering_field">[docs]</a>    <span class="k">def</span> <span class="nf">is_engineering_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if *field* is engineering field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;ENG&#39;</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] Field &#39;</span><span class="si">{}</span><span class="s2">&#39; of &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvobj</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keep_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ts_format</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dq</span><span class="p">,</span> <span class="n">sq</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">pvobj</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">QCallback</span><span class="p">(</span><span class="n">dq</span><span class="p">,</span> <span class="n">sq</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">):</span>
                <span class="n">all_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dq</span><span class="o">.</span><span class="n">qsize</span><span class="p">())])</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">all_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_raw</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">convert_epoch</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts_format</span><span class="p">),</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">convert_epoch</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts_format</span><span class="p">),</span> <span class="n">all_data</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="n">pvobj</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pvobj</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">convert_epoch</span><span class="p">(</span><span class="n">pvobj</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">ts_format</span><span class="p">),</span> <span class="p">[]</span>

<div class="viewcode-block" id="CaField.connected"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.connected">[docs]</a>    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="s2">&quot;readback&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the *handle* is connected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;readback&#39;</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readback_pv</span>
        <span class="k">elif</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_pv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readset_pv</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">connected</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pvs</span><span class="p">}</span> <span class="o">==</span> <span class="p">{</span><span class="kc">True</span><span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">get_pv_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;readback&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;readback&#39;</span><span class="p">:</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readback</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">:</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pv</span>

<div class="viewcode-block" id="CaField.current_setting"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.current_setting">[docs]</a>    <span class="k">def</span> <span class="nf">current_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return current setpoint value.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        value : get current readback value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">(</span><span class="s1">&#39;setpoint&#39;</span><span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">] is not connected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setpoint_pv</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="CaField.set_auto_monitor"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.set_auto_monitor">[docs]</a>    <span class="k">def</span> <span class="nf">set_auto_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_monitor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="s1">&#39;readback&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set auto_monitor bit True or False for the given PV type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;readback&#39;</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readback_pv</span>
        <span class="k">elif</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_pv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readset_pv</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pvs</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">auto_monitor</span> <span class="o">=</span> <span class="n">auto_monitor</span></div>

<div class="viewcode-block" id="CaField.get_auto_monitor"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.get_auto_monitor">[docs]</a>    <span class="k">def</span> <span class="nf">get_auto_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="s1">&#39;readback&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get auto_monitor bit for the given PV type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;readback&#39;</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readback_pv</span>
        <span class="k">elif</span> <span class="n">handle</span> <span class="o">==</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_pv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readset_pv</span>
        <span class="n">am_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">pv</span><span class="o">.</span><span class="n">auto_monitor</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvs</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">am_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">am_set</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;All </span><span class="si">{}</span><span class="s2"> PVs should have the same monitoring policy.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">run_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_callback</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">kws</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>
        <span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span>

<div class="viewcode-block" id="CaField.add_callback"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaField.add_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add callback to CaField.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span></div>
        <span class="c1"># self.run_callbacks()</span>

    <span class="k">def</span> <span class="nf">remove_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">read_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool: If field readable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">pv</span><span class="o">.</span><span class="n">read_access</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readback_pv</span><span class="p">}</span> <span class="o">==</span> <span class="p">{</span><span class="kc">True</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">write_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool: If field writable.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">(</span><span class="s1">&#39;setpoint&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">pv</span><span class="o">.</span><span class="n">write_access</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_pv</span><span class="p">}</span> <span class="o">==</span> <span class="p">{</span><span class="kc">True</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;tuple: (read_access, write_access), access permission of field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read</span>
        <span class="n">read_access</span> <span class="o">=</span> <span class="p">{</span><span class="n">pv</span><span class="o">.</span><span class="n">read_access</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readback_pv</span><span class="p">}</span>
        <span class="c1"># write</span>
        <span class="n">write_access</span> <span class="o">=</span> <span class="p">{</span><span class="n">pv</span><span class="o">.</span><span class="n">write_access</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setpoint_pv</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">read_access</span> <span class="o">==</span> <span class="p">{</span><span class="kc">True</span><span class="p">},</span> <span class="n">write_access</span> <span class="o">==</span> <span class="p">{</span><span class="kc">True</span><span class="p">}</span></div>


<div class="viewcode-block" id="CaElement"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement">[docs]</a><span class="k">class</span> <span class="nc">CaElement</span><span class="p">(</span><span class="n">BaseElement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Element with Channel Access support.</span>

<span class="sd">    This class could be used to create an element with data from Channel Finder Service</span>
<span class="sd">    or input keyword parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    enable : True or False</span>
<span class="sd">        Element is enabled or not, ``True`` is controllable, default is True.</span>

<span class="sd">    Keyword Arguments</span>
<span class="sd">    -----------------</span>
<span class="sd">    name : str</span>
<span class="sd">        Element name.</span>
<span class="sd">    family : str</span>
<span class="sd">        Element type.</span>
<span class="sd">    index : int</span>
<span class="sd">        Element index, default sort key, otherwise, ``sb`` is used as sort key.</span>
<span class="sd">    length : float</span>
<span class="sd">        Effective element length.</span>
<span class="sd">    sb : float</span>
<span class="sd">        Longitudinal position at the beginning point, unit: *m*.</span>
<span class="sd">    se : float</span>
<span class="sd">        Longitudinal position at the end point, unit: *m*.</span>
<span class="sd">    virtual : bool</span>
<span class="sd">        pass</span>
<span class="sd">    tags : dict</span>
<span class="sd">        Tags for each PV as key name and set of strings as tag names.</span>
<span class="sd">    fields : dict</span>
<span class="sd">        pass</span>
<span class="sd">    enable : True or False</span>
<span class="sd">        Element is enabled or not, ``True`` is controllable, default is True.</span>
<span class="sd">    pv_data : list or dict</span>
<span class="sd">        PV record data to build an element, should be of a list of:</span>
<span class="sd">        ``string of PV name, dict of properties, list of tags``, or</span>
<span class="sd">        with dict of keys of: ``pv_name``, ``pv_props`` and ``pv_tags``.</span>
<span class="sd">    auto_monitor : bool</span>
<span class="sd">        If set True, initialize all channels auto subscribe, default is False.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    If *pv_data* is defined, element will be initialized with data from</span>
<span class="sd">    *pv_data*, if *pv_data* is CFS formatted, ``simplify_data`` should be used</span>
<span class="sd">    first to convert data structure.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :func:`~phantasy.library.misc.miscutils.simplify_data`</span>
<span class="sd">        Convert CFS formatted data into simple tuple.</span>
<span class="sd">    :class:`phantasy.library.pv.datasource.DataSource`</span>
<span class="sd">        PV data source.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virtual</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;virtual&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CaElement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># unicorn laws, {(f1, f2): fn1, (f2, f1): fn2, ...}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__unicorn</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">pv_data</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv_data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">am</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auto_monitor&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pv_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pv_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_pv</span><span class="p">(</span><span class="o">*</span><span class="n">pv_data</span><span class="p">,</span> <span class="n">auto_monitor</span><span class="o">=</span><span class="n">am</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pv_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_pv</span><span class="p">(</span><span class="o">**</span><span class="n">pv_data</span><span class="p">,</span> <span class="n">auto_monitor</span><span class="o">=</span><span class="n">am</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;dict: Last setting(s) for all dynamic field(s).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_settings</span>

    <span class="nd">@last_settings</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">last_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_settings</span> <span class="o">=</span> <span class="n">x</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">design_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;dict: Physics design setting(s) for all dynamic field(s).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_design_settings</span>

    <span class="nd">@design_settings</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">design_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_design_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_design_settings</span> <span class="o">=</span> <span class="n">x</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;dict: Tags that element PVs have been assigned.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>

    <span class="nd">@tags</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;tags&#39; should be a valid dict.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool: Virtual element or not.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_virtual</span>

    <span class="nd">@virtual</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_virtual</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_virtual</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;list: Valid Channel Access field names.</span>

<span class="sd">        Warnings</span>
<span class="sd">        --------</span>
<span class="sd">        *fields* can only accept dict, with CA field name as key and ``CaField`` as value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@fields</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="n">f</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;fields&#39; should be a valid dict.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CaElement.get_phy_fields"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.get_phy_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_phy_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of all physics fields.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        If returned list is empty, but `get_eng_fields` is not, then physics</span>
<span class="sd">        fields should be the same as engineering fields, but only appeared as</span>
<span class="sd">        ENG field type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_physics_field</span><span class="p">()]</span></div>

<div class="viewcode-block" id="CaElement.get_eng_fields"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.get_eng_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_eng_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of all engineering fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_engineering_field</span><span class="p">()]</span></div>

    <span class="k">def</span> <span class="nf">_update_ca_props</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;CA&quot;&quot;&quot;</span>
        <span class="n">am</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auto_monitor&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">build_pv_policy_phy</span><span class="p">(</span><span class="n">fn_p</span><span class="p">,</span> <span class="n">fn_n</span><span class="p">,</span> <span class="n">pv_policy</span><span class="p">):</span>
            <span class="c1"># pv_policy is a dict</span>
            <span class="n">f_read</span><span class="p">,</span> <span class="n">f_write</span> <span class="o">=</span> <span class="n">pv_policy</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">],</span> <span class="n">pv_policy</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>

            <span class="nd">@unicorn_read</span><span class="p">(</span><span class="n">fn_p</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">f_read_phy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">f_read</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="nd">@unicorn_write</span><span class="p">(</span><span class="n">fn_n</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">f_write_phy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
                <span class="n">f_write</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">f_read_phy</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span> <span class="n">f_write_phy</span><span class="p">}</span>

        <span class="n">handle_name</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;handle&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field_eng&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># engineering field name</span>
        <span class="c1"># if field_phy is undefined, use the same as field_eng</span>
        <span class="n">field_name_phy</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field_phy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># if eng and phy has the same name:</span>
        <span class="k">if</span> <span class="n">field_name_phy</span> <span class="o">==</span> <span class="n">field_name</span><span class="p">:</span>
            <span class="n">field_name_phy</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">_phy&quot;</span>
        <span class="c1">#</span>
        <span class="n">pv_policy_str</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv_policy&#39;</span><span class="p">,</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">)</span>

        <span class="n">pv_policy</span> <span class="o">=</span> <span class="n">PV_POLICIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pv_policy_str</span><span class="p">)</span>
        <span class="c1"># pv_policy passed as string, which is defined in channels datafile,</span>
        <span class="c1"># while pv_policy passed to CaField is a dict: {&#39;read&#39;: rp, &#39;write&#39;: wp}</span>
        <span class="n">u_policy</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;u_policy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u_policy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u_policy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">k_e2p</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_name_phy</span><span class="p">)</span>
        <span class="n">k_p2e</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_name_phy</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="n">f_e2p</span> <span class="o">=</span> <span class="n">u_policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k_e2p</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">f_p2e</span> <span class="o">=</span> <span class="n">u_policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k_p2e</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f_e2p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_p2e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pv_policy_phy</span> <span class="o">=</span> <span class="n">build_pv_policy_phy</span><span class="p">(</span><span class="n">f_e2p</span><span class="p">,</span> <span class="n">f_p2e</span><span class="p">,</span> <span class="n">pv_policy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pv_policy_phy</span> <span class="o">=</span> <span class="n">PV_POLICIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pv_policy_str</span><span class="p">)</span>
            <span class="n">f_e2p</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span>
            <span class="n">f_p2e</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span>

        <span class="n">pv</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">polarity</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;polarity&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__unicorn</span><span class="p">[</span><span class="n">k_e2p</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_e2p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">handle_name</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;ENG&#39;</span><span class="p">,</span>
                           <span class="n">pv_policy</span><span class="o">=</span><span class="n">pv_policy</span><span class="p">,</span> <span class="n">auto_monitor</span><span class="o">=</span><span class="n">am</span><span class="p">,</span>
                           <span class="n">polarity</span><span class="o">=</span><span class="n">polarity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_name_phy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__unicorn</span><span class="p">[</span><span class="n">k_p2e</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_p2e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">field_name_phy</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">handle_name</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;PHY&#39;</span><span class="p">,</span>
                           <span class="n">pv_policy</span><span class="o">=</span><span class="n">pv_policy_phy</span><span class="p">,</span> <span class="n">auto_monitor</span><span class="o">=</span><span class="n">am</span><span class="p">,</span>
                           <span class="n">polarity</span><span class="o">=</span><span class="n">polarity</span><span class="p">)</span>

<div class="viewcode-block" id="CaElement.set_field"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.set_field">[docs]</a>    <span class="k">def</span> <span class="nf">set_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set element field with CA support, i.e. dynamic field.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field : str</span>
<span class="sd">            Field name.</span>
<span class="sd">        pv : str</span>
<span class="sd">            Valid PV name.</span>
<span class="sd">        handle : str</span>
<span class="sd">            PV channel type, valid options: ``readback``, ``readset``,</span>
<span class="sd">            ``setpoint``, default is ``readback``.</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        pv_policy : dict</span>
<span class="sd">            Name of PV read/write policy, keys: &#39;read&#39; and &#39;write&#39;, values:</span>
<span class="sd">            scaling law function object.</span>
<span class="sd">        ftype : str</span>
<span class="sd">            Field type, &#39;ENG&#39; (default) or &#39;PHY&#39;.</span>
<span class="sd">        auto_monitor : bool</span>
<span class="sd">            If set True, initialize all channels auto subscribe, default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="s1">&#39;readback&#39;</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">new_field</span> <span class="o">=</span> <span class="n">CaField</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                                <span class="n">ename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">ftype</span><span class="o">=</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ftype&#39;</span><span class="p">),</span>
                                <span class="n">pv_policy</span><span class="o">=</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv_policy&#39;</span><span class="p">),</span>
                                <span class="n">polarity</span><span class="o">=</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;polarity&#39;</span><span class="p">),</span>
                                <span class="n">auto_monitor</span><span class="o">=</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auto_monitor&#39;</span><span class="p">),</span>
                                <span class="o">**</span><span class="p">{</span><span class="n">handle</span><span class="p">:</span> <span class="n">pv</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_design_settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">field</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">field</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_field</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">update_pv</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">handle</span><span class="p">:</span> <span class="n">pv</span><span class="p">})</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Process &#39;</span><span class="si">{0}</span><span class="s2">&#39; PV: </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span></div>

<div class="viewcode-block" id="CaElement.update_properties"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.update_properties">[docs]</a>    <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update element properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        props : dict</span>
<span class="sd">            Dictionary of properties, two categories:</span>

<span class="sd">            - static properties: without CA features:</span>
<span class="sd">              *name*, *family*, *index*, *se*, *sb* (optional), *length*</span>
<span class="sd">            - dynamic properties: with CA features:</span>
<span class="sd">              *handle*, *field*</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        pv : str</span>
<span class="sd">            Valid PV name.</span>
<span class="sd">        auto_monitor : bool</span>
<span class="sd">            If set True, initialize all channels auto subscribe, default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prop_st</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">VALID_STATIC_KEYS</span><span class="p">}</span>
        <span class="n">prop_ca</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">VALID_CA_KEYS</span><span class="p">}</span>
        <span class="n">prop_st</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;alignment&#39;</span><span class="p">:</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alignment_series&#39;</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_static_props</span><span class="p">(</span><span class="n">prop_st</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ca_props</span><span class="p">(</span><span class="n">prop_ca</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span></div>

<div class="viewcode-block" id="CaElement.update_tags"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.update_tags">[docs]</a>    <span class="k">def</span> <span class="nf">update_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update element tags.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tags : list</span>
<span class="sd">            List of tags.</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        pv : str</span>
<span class="sd">            Valid PV name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pv_name</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pv_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pv_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">[</span><span class="n">pv_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">[</span><span class="n">pv_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="CaElement.process_pv"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.process_pv">[docs]</a>    <span class="k">def</span> <span class="nf">process_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv_name</span><span class="p">,</span> <span class="n">pv_props</span><span class="p">,</span> <span class="n">pv_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">u_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">polarity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">alignment_series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process PV record to update element with properties and tags.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pv_name : str</span>
<span class="sd">            PV name.</span>
<span class="sd">        pv_props : dict</span>
<span class="sd">            PV properties, key-value pairs.</span>
<span class="sd">        pv_tags : list</span>
<span class="sd">            PV tag list.</span>
<span class="sd">        u_policy : dict</span>
<span class="sd">            Dict of unit conversion policies.</span>
<span class="sd">        polarity : int</span>
<span class="sd">            Device polarity, -1 or 1.</span>
<span class="sd">        alignment_series : Series</span>
<span class="sd">            A series of alignment data, dx,dy,dz,pitch,roll,yaw.</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        auto_monitor : bool</span>
<span class="sd">            If set True, initialize all channels auto subscribe, default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pv_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pv_name</span><span class="p">)))</span>

        <span class="c1"># properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_properties</span><span class="p">(</span><span class="n">pv_props</span><span class="p">,</span> <span class="n">pv</span><span class="o">=</span><span class="n">pv_name</span><span class="p">,</span> <span class="n">u_policy</span><span class="o">=</span><span class="n">u_policy</span><span class="p">,</span>
                               <span class="n">polarity</span><span class="o">=</span><span class="n">polarity</span><span class="p">,</span> <span class="n">alignment_series</span><span class="o">=</span><span class="n">alignment_series</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="c1"># tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="n">pv_tags</span><span class="p">,</span> <span class="n">pv</span><span class="o">=</span><span class="n">pv_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_groups</span><span class="p">(</span><span class="n">pv_props</span><span class="p">,</span> <span class="n">pv</span><span class="o">=</span><span class="n">pv_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="CaElement.update_groups"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.update_groups">[docs]</a>    <span class="k">def</span> <span class="nf">update_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update new group with *family* name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        props : dict</span>
<span class="sd">            Element properties.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        update_properties</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_groups</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_groups</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">new_groups</span> <span class="o">=</span> <span class="n">new_groups</span><span class="p">,</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">new_groups</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_family</span><span class="p">)</span></div>

<div class="viewcode-block" id="CaElement.get_field"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.get_field">[docs]</a>    <span class="k">def</span> <span class="nf">get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get element field of CA support.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field : str</span>
<span class="sd">            Field name.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        All valid field names could be retrieved by ``fields`` attribute.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ret :</span>
<span class="sd">            CaField or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> of </span><span class="si">{0}</span><span class="s2"> is not defined, valid ones are (</span><span class="si">{2}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">))))</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;element </span><span class="si">{}</span><span class="s2"> does not have field </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">fld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">ensure_put</span><span class="p">:</span>
                <span class="n">ensure_put</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">tolerance</span><span class="p">,</span> <span class="n">fld</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_settings</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CaElement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="n">CaElement</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtual</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> [</span><span class="si">%s</span><span class="s2">] (virtual)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CaElement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

<div class="viewcode-block" id="CaElement.pv"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.pv">[docs]</a>    <span class="k">def</span> <span class="nf">pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get PV names with defined *field* and *handle*, if none of them is defined,</span>
<span class="sd">        return all PV names.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field : str or list</span>
<span class="sd">            Channel access field name, all available fields will be used</span>
<span class="sd">            if not defined, ignore invalid field.</span>
<span class="sd">        handle : str</span>
<span class="sd">            Channel access protocol type, could be one of *readback*, *readset*</span>
<span class="sd">            and *setpoint*.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        1. All Valid field names could be retrieved by ``fields`` attribute.</span>
<span class="sd">        2. If more than one field is defined with *field*, i.e. *field* is a list</span>
<span class="sd">           of string, return PV names binding with these fields, may apply *handle*</span>
<span class="sd">           as a filter, e.g. if *handle* is not defined, return all PVs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ret : list</span>
<span class="sd">            List of valid PVs as request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pvs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">pvs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">pvs</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_pv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">,</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">]:</span>
                <span class="n">f_pv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">pvs</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">pv_i</span> <span class="ow">in</span> <span class="n">f_pv</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pvs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pv_i</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">handle</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;readback&#39;</span><span class="p">,</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;readset&#39;</span><span class="p">]:</span>
                    <span class="n">pvs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pv_i</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="n">handle</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid handle, valid options: &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;&#39;readback&#39;, &#39;readset&#39;, &#39;setpoint&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">flatten</span><span class="p">(</span><span class="n">pvs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CaElement.convert"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">from_field</span><span class="p">,</span> <span class="n">to_field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interpret the *value* of *from_field* of element to the value of *to_field*,</span>
<span class="sd">        if *to_field* is not defined, choose the first out of all candidators (sorted).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : float</span>
<span class="sd">            Value of field, no necessary be the current online reading.</span>
<span class="sd">        from_field : str</span>
<span class="sd">            Field name of element, which the paramter *value* stands for.</span>
<span class="sd">        to_field : str</span>
<span class="sd">            Field name of element.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        r : float</span>
<span class="sd">            Value Interpreted in another unit, from physics engineering or</span>
<span class="sd">            from engineering to physics, depends on the field type.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; mp = MachinePortal(&quot;FRIB&quot;, &quot;MEBT&quot;)</span>
<span class="sd">        &gt;&gt;&gt; quad = mp.get_elements(type=&#39;QUAD&#39;, name=&#39;*D1078*&#39;)[0]</span>
<span class="sd">        &gt;&gt;&gt; # convert I = 100 A, to gradient 15.177 T/m</span>
<span class="sd">        &gt;&gt;&gt; quad.convert(value=100, from_field=&#39;I&#39;)</span>
<span class="sd">        15.17734389601</span>
<span class="sd">        &gt;&gt;&gt; quad.convert(value=15, from_field=&#39;B2&#39;)</span>
<span class="sd">        98.7534891752199</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">from_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid field name *from_field*.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">to_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">to_field</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">from_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unicorn</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">to_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid field name *to_field*.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">from_field</span> <span class="o">==</span> <span class="n">to_field</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unicorn</span><span class="p">[(</span><span class="n">from_field</span><span class="p">,</span> <span class="n">to_field</span><span class="p">)](</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="CaElement.current_setting"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.current_setting">[docs]</a>    <span class="k">def</span> <span class="nf">current_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value of current setting (setpoint) for dynamic field</span>
<span class="sd">        defined by *field*, if setpoint PV is not available, return None.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field : str</span>
<span class="sd">            Name of valid dynamic field.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        r :</span>
<span class="sd">            Field current setting or None.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        get_settings : Get field setpoint value from given setpoint pv values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid field, should be one of </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">fld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fld</span><span class="o">.</span><span class="n">current_setting</span><span class="p">()</span></div>

<div class="viewcode-block" id="CaElement.get_settings"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.get_settings">[docs]</a>    <span class="k">def</span> <span class="nf">get_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the *field* value from *settings*, set / read defined by *handle*</span>
<span class="sd">        keyword argument.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field : str</span>
<span class="sd">            Dynamic field name of element.</span>
<span class="sd">        settings : dict</span>
<span class="sd">            Key-value pairs of setpoint PV name and value.</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        handle : str</span>
<span class="sd">            PV handle, &#39;readback&#39;, &#39;readset&#39; or &#39;setpoint&#39; (default).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        r : float</span>
<span class="sd">            Setting value of defined dynamic field, or None.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        current_setting : Get current field setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;handle&#39;</span><span class="p">,</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">)</span>
        <span class="n">fld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">sp_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">handle</span><span class="p">)]</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">sp_vals</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Failed to get </span><span class="si">{}</span><span class="s2"> PV reading(s) of &#39;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Failed to get </span><span class="si">{}</span><span class="s2"> PV reading(s) of &#39;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">fld</span><span class="o">.</span><span class="n">read_policy</span><span class="p">([</span><span class="n">Number</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sp_vals</span><span class="p">])</span></div>

<div class="viewcode-block" id="CaElement.ensure_put"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.ensure_put">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure set the *field* of element to *goal* within the</span>
<span class="sd">        discrepancy tolerance of *tol*, within the max *timeout* secs.</span>
<span class="sd">        If field is invalid, return None.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field : str</span>
<span class="sd">            Dynamic field name of element.</span>
<span class="sd">        goal : float</span>
<span class="sd">            The final value that the field of element would like to reach.</span>
<span class="sd">        tol : float</span>
<span class="sd">            Tolerance for discrepancy between current readback</span>
<span class="sd">            value and the set goal, default is 0.01.</span>
<span class="sd">        timeout : float</span>
<span class="sd">            Maximum wait time, default is 10.0 sec.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        r : str</span>
<span class="sd">            Returns what `ensure_put` returns, or None.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`~phantasy.library.pv.epics_tools.ensure_put`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fld</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">ensure_put</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="CaElement.get_current_settings"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.get_current_settings">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_of_interest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">only_physics</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current setpoint readings of interested dynamic fields.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        field_of_interest : list</span>
<span class="sd">            Interested physics field names, if not defined, use all valid ones.</span>
<span class="sd">        only_physics : bool</span>
<span class="sd">            If `True`, only return physics settings otherwise return both</span>
<span class="sd">            physics and engineering field settings.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s : Settings</span>
<span class="sd">            Settings of interested physics fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phy_fields</span><span class="p">()</span> <span class="k">if</span> <span class="n">field_of_interest</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">field_of_interest</span>
        <span class="k">return</span> <span class="n">get_settings_from_element_list</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">data_source</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span>
                            <span class="n">field_of_interest</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">field_list</span><span class="p">},</span>
                            <span class="n">only_physics</span><span class="o">=</span><span class="n">only_physics</span><span class="p">)</span></div>

<div class="viewcode-block" id="CaElement.get_focusing_polarity"><a class="viewcode-back" href="../../../../src/apidocs/lattice.html#phantasy.CaElement.get_focusing_polarity">[docs]</a>    <span class="k">def</span> <span class="nf">get_focusing_polarity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Only work with QUAD.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="s1">&#39;QUAD&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;X-focusing&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;B2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_polarity</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;Y-focusing&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<span class="k">class</span> <span class="nc">Number</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_monitor</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">validate_polarity</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate policy *fn* with *polarity*, return True if polarity is consistent, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_n</span> <span class="o">=</span> <span class="n">Number</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;read&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">fn</span><span class="p">([</span><span class="n">test_n</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">==</span> <span class="n">polarity</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># write</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">([</span><span class="n">test_n</span><span class="p">],</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">test_n</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">==</span> <span class="n">polarity</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">build_element</span><span class="p">(</span><span class="n">sp_pv</span><span class="p">,</span> <span class="n">rd_pv</span><span class="p">,</span> <span class="n">ename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build CaElement from general setpoint and readback PV names, *sp_pv*</span>
<span class="sd">    and *rd_pv* could be the same. The created CaElement is of the element</span>
<span class="sd">    name defined by *ename*, and engineering field name defined by *fname*,</span>
<span class="sd">    the corresponding physics field is defined as *fname*_phy.</span>

<span class="sd">    If *ename* or *fname* is not defined, smart matching will be applied to find the</span>
<span class="sd">    element name from PV names based on naming convention.</span>

<span class="sd">    e.g.: PV is named as: SYSTEM_SUBSYS:DTYPE_DNUM:FIELD_HANDLE, then ename is</span>
<span class="sd">    &quot;SYSTEM_SUBSYS:DTYPE_DNUM&quot;, engineering field name is &quot;FIELD&quot;, physics</span>
<span class="sd">    field name is &quot;FIELD_PHY&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sp_pv : str</span>
<span class="sd">        Setpoint PV name.</span>
<span class="sd">    rd_pv : str</span>
<span class="sd">        Readback PV name.</span>
<span class="sd">    ename : str</span>
<span class="sd">        Element name.</span>
<span class="sd">    fname : str</span>
<span class="sd">        Field name.</span>

<span class="sd">    Keyword Arguments</span>
<span class="sd">    -----------------</span>
<span class="sd">    field_phy : str</span>
<span class="sd">        Physics field name w.r.t. *fname*.</span>
<span class="sd">    index : int</span>
<span class="sd">        Element index, default is -1.</span>
<span class="sd">    length : float</span>
<span class="sd">        Element length, default is 0.0.</span>
<span class="sd">    sb : float</span>
<span class="sd">        Start s-position of element, default is -1.0, if not defined, will</span>
<span class="sd">        try to extract from the PV name.</span>
<span class="sd">    family : str</span>
<span class="sd">        Element family (type), default is &#39;PV&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    elem : CaElement</span>
<span class="sd">        CaElement object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ename_</span><span class="p">,</span> <span class="n">fname_</span> <span class="o">=</span> <span class="n">_parse_pv_name</span><span class="p">(</span><span class="n">sp_pv</span><span class="p">)</span>
    <span class="n">ename</span> <span class="o">=</span> <span class="n">ename</span> <span class="k">if</span> <span class="n">ename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ename_</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fname_</span>
    <span class="n">fname_phy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_PHY&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="n">elem</span> <span class="o">=</span> <span class="n">CaElement</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ename</span><span class="p">)</span>
    <span class="n">pv_props</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;field_eng&#39;</span><span class="p">:</span> <span class="n">fname</span><span class="p">,</span>
        <span class="s1">&#39;field_phy&#39;</span><span class="p">:</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field_phy&#39;</span><span class="p">,</span> <span class="n">fname_phy</span><span class="p">),</span>
        <span class="s1">&#39;handle&#39;</span><span class="p">:</span> <span class="s1">&#39;readback&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pv_policy&#39;</span><span class="p">:</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="s1">&#39;sb&#39;</span><span class="p">:</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="n">_get_spos</span><span class="p">(</span><span class="n">sp_pv</span><span class="p">)),</span>
        <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;family&#39;</span><span class="p">,</span> <span class="s1">&#39;PV&#39;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">pv_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pv</span><span class="p">,</span> <span class="n">handle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">sp_pv</span><span class="p">,</span> <span class="n">rd_pv</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;setpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;readback&#39;</span><span class="p">)):</span>
        <span class="n">pv_props</span><span class="p">[</span><span class="s1">&#39;handle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="n">elem</span><span class="o">.</span><span class="n">process_pv</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">pv_props</span><span class="p">,</span> <span class="n">pv_tags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">elem</span>


<span class="k">def</span> <span class="nf">_get_spos</span><span class="p">(</span><span class="n">pvname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract s-position from PV name.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This is FRIB specific, D### to meter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pos : float</span>
<span class="sd">        S-pos of PV device.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pos</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*D([0-9]</span><span class="si">{4}</span><span class="s1">).*&#39;</span><span class="p">,</span> <span class="n">pvname</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">10.0</span>  <span class="c1"># m</span>
    <span class="k">return</span> <span class="n">pos</span>


<span class="k">def</span> <span class="nf">_parse_pv_name</span><span class="p">(</span><span class="n">pvname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract element name, field name from pv name, based on the following</span>
<span class="sd">    naming convention: SYSTEM_SUBSYS:DEVICE_D####:FIELD_HANDLE,</span>
<span class="sd">    if HANDLE is not CSET nor RD, FIELD_HANDLE will be extracted as field name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pvname : str</span>
<span class="sd">        PV name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    r : tuple</span>
<span class="sd">        A tuple of element name, field name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pattern1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(.*):(.*)_(CSET|RD)&quot;</span>
    <span class="n">pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(.*):(.*)&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern1</span><span class="p">,</span> <span class="n">pvname</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern2</span><span class="p">,</span> <span class="n">pvname</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ename</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">element_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ename</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">field_name</span> <span class="o">=</span> <span class="n">fname</span>
    <span class="k">return</span> <span class="n">element_name</span><span class="p">,</span> <span class="n">field_name</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">pv_props</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="s1">&#39;ANG&#39;</span><span class="p">,</span> <span class="s1">&#39;handle&#39;</span><span class="p">:</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">,</span>
        <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;HCOR&#39;</span><span class="p">,</span>
        <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">elem</span> <span class="o">=</span> <span class="n">CaElement</span><span class="p">(</span><span class="o">**</span><span class="n">pv_props</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">family</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Facility for Rare Isotope Beams, Michigan State University.
      <span class="lastupdated">Last updated on Oct 29, 2021.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>